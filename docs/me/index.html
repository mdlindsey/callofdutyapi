<!DOCTYPE html>
<html lang='en'>
<head>
	<meta class="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Dashboard / Call of Duty API - Provided by WARZONE.AI</title>
	<!-- Don't forget to add your metadata here -->
	<link rel='stylesheet' href='../assets/css/style.css' />
	<link rel='shortcut icon' type='image/x-icon' href='../assets/img/favicon.ico' />
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-NL88L2YKLJ"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());
		gtag('config', 'G-NL88L2YKLJ');
	</script>
    <style type="text/css">
        #dashboard {
            min-height: 90vh;
            padding-top: 10vh;
            padding-bottom: 128px;
        }
        #create-app-button {
            position: absolute;
            top: 0;
            right: 0;
        }
        .two-pane-panel {
            position: relative;
            display: inline-block;
            vertical-align: top;
            width: calc(50% - 32px);
        }

        @media all and (min-width:0px) and (max-width: 768px) {
            .two-pane-panel {
                position: relative;
                display: block;
                width: 100%;
            }
            .two-pane-panel:nth-of-type(2) {
                margin-top: 64px;
            }
        }

        #dashboard ul {
            list-style: none;
            margin: 32px 0 0 0;
            padding: 0;
        }
        #dashboard li {
            padding: 0;
            border: 1px solid transparent;
        }
        #dashboard > .two-pane-panel > ul > li:hover,
        #dashboard > .two-pane-panel > ul > li.expanded {
            border-color: rgba(0,0,0,0.05);
        }
        #dashboard > .two-pane-panel > ul > li h3 {
            margin: 0;
            padding: 0;
            display: inline-block;
            width: 60%;
            cursor: pointer;
        }
        #dashboard > .two-pane-panel > ul > li a {
            display: inline-block;
            width: 40%;
            text-align: right;
        }
        #dashboard > .two-pane-panel > ul > li .app-header {
            padding: 12px;
        }
        #dashboard > .two-pane-panel > ul > li.expanded .app-header,
        #dashboard > .two-pane-panel > ul > li .app-header:hover {
            background: rgba(0,0,0,0.05);
        }
        #dashboard > .two-pane-panel > ul > li .app-details {
            display: none;
        }
        #dashboard > .two-pane-panel > ul > li.expanded .app-details {
            display: block;
        }

        #dashboard > .two-pane-panel > ul > li.expanded .app-details h4 {
            margin: 0;
            padding: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        #dashboard > .two-pane-panel > ul > li.expanded .app-details div h4 {
            display: inline-block;
            width: calc(50% - 18px);
        }

        #dashboard > .two-pane-panel > ul > li.expanded .app-details div h4 + a,
        #dashboard > .two-pane-panel > ul > li.expanded .app-details div h4 + p,
        #dashboard > .two-pane-panel > ul > li.expanded .app-details div h4 + input {
            display: inline-block;
            text-align: right;
            width: 50%;
        }
        #dashboard > .two-pane-panel > ul > li.expanded .app-details div h4 + input {
            border-radius: 8px;
            text-align: left;
            padding: 8px;
        }
        
        #dashboard > .two-pane-panel > ul > li.expanded .app-details ul {
            margin-top: 0;
        }
        #dashboard > .two-pane-panel > ul > li.expanded .app-details ul li {
            padding: 12px;
        }
        #dashboard > .two-pane-panel > ul > li.expanded .app-details ul li h6 {
            display: inline-block;
            width: 50%;
        }
        #dashboard > .two-pane-panel > ul > li.expanded .app-details ul li h6 + input {
            display: inline-block;
            border-radius: 8px;
            text-align: left;
            padding: 8px;
            width: 50%;
            margin-bottom: 0;
        }
        #dashboard > .two-pane-panel > ul > li.expanded .app-details ul li:hover {
            background: rgba(0,0,0,0.05);
        }
        #dashboard > .two-pane-panel > ul > li.expanded .app-details ul li h6:nth-of-type(2) {
            text-align: right;
        }

        ul#authorized-apps {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        ul#authorized-apps > li {
            padding: 0;
            margin: 0;
            width: 80%;
            position: relative;
        }
        ul#authorized-apps > li:hover {
            border-color: transparent !important;
        }
        ul#authorized-apps > li > * {
            display: inline-block;
        }
        ul#authorized-apps > li > *:nth-child(1) {
            margin: 0;
            padding: 0;
            width: 70%;
        }
        ul#authorized-apps > li > *:nth-child(2) {
            position: absolute;
            top: 0;
            right: 24px;
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
	<div class="navbar">
		<nav class="nav__mobile"></nav>
		<div class="container">
			<div class="navbar__inner">
				<a href="/" class="navbar__logo"><span id="api-status-indicator"></span>Call of Duty API</a>
				<nav class="navbar__menu">
					<ul>
						<li><a href="#logout" onClick={logout()}>Sign out</a></li>
					</ul>
				</nav>
				<div class="navbar__menu-mob"><a href="" id='toggle'><svg role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z" class=""></path></svg></a></div>
			</div>
		</div>
	</div>

    <div class="container" id="dashboard">
        <div class="two-pane-panel">
            <h1 class="data-uno-username"></h1>
            <h6>Games: <span class="data-games"></span></h6>
            <h2>Stripe payments coming soon...</h2>
            
            <h3>Authorized Apps</h3>
            <ul id="authorized-apps">
                
            </ul>



        </div>
        <div class="two-pane-panel">
            <button id="create-app-button" onclick={createNewApp()}>Create App</button>
            <h2 style="margin: 0 0 32px 0;">My Applications</h2>
            <hr />
            <ul id="apps-container">
            </ul>
        </div>
    </div>

	
	<!-- Footer -->
	<div class="footer footer--dark">
		<div class="container">
			<div class="footer__inner">
				<a href="https://callofdutyapi.com" class="footer__textLogo">Call of Duty API</a>
				<div class="footer__data">
					<div class="footer__data__item">
						<div class="footer__row">
							Created by <a href="https://github.com/mdlindsey" target="_blank" class="footer__link">Dan Lindsey</a>
						</div>
					</div>
					<div class="footer__data__item">
						<div class="footer__row">
							UI Design by <a href="https://undraw.co" target="_blank" class="footer__link">unDraw</a>
						</div>
					</div>
					<div class="footer__data__item">
					<div class="footer__row">
						<a href="https://www.npmjs.com/package/@callofduty/api" target="_blank" class="footer__link">NPM</a>
					</div>
					<div class="footer__row">
						<a href="https://github.com/mdlindsey/callofdutyapi" target="_blank" class="footer__link">GitHub</a>
					</div>
					<div class="footer__row">
						<a href="https://warzone.ai/discord/join" target="_blank" class="footer__link">Discord</a>
					</div>
				</div>
			</div>
		</div>
	</div>
<script src='../assets/js/app.js'></script>
<script>
    if (!localStorage.getItem('jwt')) {
        window.location.href = '../login'
    }
    function parseJwt(token) {
        try {
            return JSON.parse(atob(token.split('.')[1]))
        } catch (e) {
            return null
        }
    }
    async function createNewApp() {
        const appName = prompt('Name your application')
        if (!appName) {
            alert('App name required')
            return
        }
        const res = await fetch(`${window.apiUrl}/apps`, {
            method: 'POST',
            headers: { 'content-type': 'application/json', 'x-jwt': localStorage.getItem('jwt') },
            body: JSON.stringify({ name: appName })
        })
        const resJson = await res.json()
        if (res.status >= 400) {
            alert(resJson.message || `${res.status} http error`)
            return
        }
        window.location.reload()
    }
    async function revokeAppAuthorization(appId, appName) {
        const confirmation = confirm(
            `Are you sure you wish to revoke access for ${appName}? ` + 
            'This is irreversible. To allow this application to fetch data for your account, '+
            'you must reauthorize the application through their website or serivce.'
        )
        if (!confirmation) {
            return
        }
        await fetch(`${window.apiUrl}/oauth/${appId}`, {
            method: 'DELETE',
            headers: { 'content-type': 'application/json', 'x-jwt': localStorage.getItem('jwt') }
        })
        window.location.reload()
    }
    function toggleAppInfo(appId) {
        const tile = document.getElementById(`app-tile__${appId}`)
        const tileStatus = document.querySelector(`#app-tile__${appId} .app-header a`)
        const isExpanded = tile.classList.contains('expanded')
        if (isExpanded) {
            tile.classList.remove('expanded')
            tileStatus.innerHTML = 'show'
        } else {
            tile.classList.add('expanded')
            tileStatus.innerHTML = 'hide'
        }
    }
    function copySecret(textToCopy) {
        var myTemporaryInputElement = document.createElement("input")
        myTemporaryInputElement.type = "text"
        myTemporaryInputElement.value = textToCopy

        document.body.appendChild(myTemporaryInputElement)

        myTemporaryInputElement.select()
        document.execCommand("Copy")

        document.body.removeChild(myTemporaryInputElement)
    }
    function logout() {
        localStorage.setItem('jwt', '')
        window.location.href = '../login'
    }
    
    const inputChangeTimeouts = {}
    const propNameFormatters = {
        urlOAuth: v => ({ url: { oauth: v } }),
        urlHookMatch: v => ({ url: { hook: { match: v } } }),
        urlHookProfile: v => ({ url: { hook: { profile: v } } }),
    }
    function updateInputAfterLilBit(appId, propName, propValue) {
        if (inputChangeTimeouts[propName]) {
            clearTimeout(inputChangeTimeouts[propName])
        }
        inputChangeTimeouts[propName] = setTimeout(() => updateAppProp(appId, propName, propValue), 1500)
    }
    async function updateAppProp(target) {
        const [appId, propName] = target.id.replace('app-prop-input__', '').split('__')
        if (inputChangeTimeouts[propName]) {
            clearTimeout(inputChangeTimeouts[propName])
        }
        inputChangeTimeouts[propName] = setTimeout(() => fetch(`${window.apiUrl}/apps/${appId}`, {
            method: 'PATCH',
            headers: { 'content-type': 'application/json', 'x-jwt': localStorage.getItem('jwt') },
            body: JSON.stringify(propNameFormatters[propName](target.value))
        }), 1500)
    }

    function loadStaticUI() {
        const me = parseJwt(localStorage.getItem('jwt'))
        document.querySelector('.data-games').innerHTML = me.user.games.map(g => g.toUpperCase()).join(', ')
        document.querySelector('.data-uno-username').innerHTML = me.user.profile.uno
    }
    async function loadAuthorizedApps() {
        const res = await fetch(`${window.apiUrl}/apps/authorized`, {
            method: 'GET',
            headers: { 'x-jwt': localStorage.getItem('jwt') },
        })
        const resJson = await res.json()
        const combinedHTML = []
        for(const app of resJson) {
            combinedHTML.push(parseAuthorizedAppHTML(app))
        }
        if (!combinedHTML.length) {
            combinedHTML.push(`<li><h4 style="width: 100%;">No authorized apps</h4></li>`)
        }
        document.getElementById('authorized-apps').innerHTML = combinedHTML.join('\n')
    }
    function parseAuthorizedAppHTML(app) {
        return `
            <li>
                <h4>${app.name}</h4>
                <a onclick="revokeAppAuthorization('${app.id}', '${app.name.split('\'').join('')}')" href="#">revoke access</a>
            </li>
        `
    }
    async function loadApps() {
        const res = await fetch(`${window.apiUrl}/apps/owned`, {
            method: 'GET',
            headers: { 'x-jwt': localStorage.getItem('jwt') },
        })
        const resJson = await res.json()
        const combinedHTML = []
        for(const app of resJson) {
            combinedHTML.push(parseAppHTML(app))
        }
        if (!combinedHTML.length) {
            combinedHTML.push(`<li style="border-color: transparent !important;"><h3 style="width: 100%;">No created apps</h3></li>`)
        }
        document.getElementById('apps-container').innerHTML = combinedHTML.join('\n')
    }
    function parseAppHTML(app) {
        return `
                <li id="app-tile__${app.id}">
                    <div class="app-header" onclick="toggleAppInfo('${app.id}');">
                        <h3>${app.name}</h3><a href="#">show</a>
                    </div>
                    <div class="app-details">
                        <div>
                            <h4>Token</h4>
                            <a onclick="copySecret('${app.token}')" href="#">copy token</a>
                        </div>
                        <div>
                            <h4>OAuth URL</h4>
                            <a onclick="copySecret('https://callofdutyapi.com/oauth?app=${app.id}')" href="#">copy url</a>
                        </div>
                        <div>
                            <h4>OAuth Redirect</h4>
                            <input id="app-prop-input__${app.id}__urlOAuth" type="text" onkeyup={updateAppProp(this)} placeholder="https://example.com/oauth" value="${app?.url?.oauth || ''}" />
                        </div>
                        <div>
                            <h4>Webhooks</h4>
                            <a href="#"></a>
                        </div>
                        <ul>
                            <li><h6>New match</h6><input type="text" placeholder="https://example.com/hooks/match" id="app-prop-input__${app.id}__urlHookMatch" type="text" onkeyup={updateAppProp(this)} value="${app?.url?.hook?.match || ''}" /></li>
                            <li><h6>Profile update</h6><input type="text" placeholder="https://example.com/hooks/profile" id="app-prop-input__${app.id}__urlHookProfile" type="text" onkeyup={updateAppProp(this)} value="${app?.url?.hook?.profile || ''}" /></li>
                        </ul>
                        <div>
                            <h4>Users</h4>
                            <a href="#">${app.users.length}</a>
                        </div>
                        <ul>
                            ${app.users.map(u => `
                                <li><h6>${u.profile.uno}</h6><h6><a onclick="copySecret('${u.token}')" href="#">copy api key</a></h6></li>
                            `).join('\n')}
                        </ul>
                    </div>
                </li>
        `
    }

    loadStaticUI()
    loadApps()
    loadAuthorizedApps()
</script>
</body>
</html>